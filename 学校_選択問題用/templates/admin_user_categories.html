{% extends "base.html" %}
{% block content %}

<div class="card">
  <h1>カテゴリ管理</h1>
  <p class="note">全ユーザーのカテゴリを一括で変更・未分類化できます。</p>

  <div style="display:flex; gap:16px; margin-top:16px;">
    <div style="flex:1;">
      <h3>カテゴリ一覧</h3>
      <ul id="cat-list" style="list-style:none; padding:0; margin:0;"></ul>
    </div>

    <div style="flex:1;">
      <h3>カテゴリ名変更</h3>
      <p class="note">「元のカテゴリ名」を選択してから、新しい名前を入力してください。</p>
      <label>元のカテゴリ</label>
      <input type="text" id="old-cat" readonly style="width:100%; padding:8px 10px; border-radius:10px; border:1px solid #d1d5db; margin-bottom:10px;">

      <label>新しいカテゴリ名</label>
      <input type="text" id="new-cat" style="width:100%; padding:8px 10px; border-radius:10px; border:1px solid #d1d5db; margin-bottom:10px;">

      <button class="btn btn-primary" onclick="renameCategory()">カテゴリ名を変更</button>

      <h3 style="margin-top:24px;">カテゴリ削除（未分類へ）</h3>
      <p class="note">選択中のカテゴリに属する問題のカテゴリを空にします。</p>
      <button class="btn btn-outline" style="background:#dc2626;" onclick="deleteCategory()">カテゴリを未分類にする</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
let selectedCategory = "";

function showToast(msg, type="success") {
  const t = document.createElement("div");
  t.className = "toast " + type;
  t.textContent = msg;
  document.getElementById("toast").appendChild(t);
  setTimeout(() => {
    t.style.opacity = "0";
    t.style.transform = "translateY(8px)";
    setTimeout(() => t.remove(), 400);
  }, 3000);
}

async function loadCategories() {
  const res = await fetch("/api/admin/categories");
  const data = await res.json();
  const list = document.getElementById("cat-list");
  list.innerHTML = data.categories.map(c => `
    <li style="padding:4px 2px;">
      <button type="button" class="btn btn-gray" style="width:100%; justify-content:flex-start;" onclick="selectCategory('${c.replace(/'/g, "\\'")}')">
        ${c}
      </button>
    </li>
  `).join("");
}

function selectCategory(cat) {
  selectedCategory = cat;
  document.getElementById("old-cat").value = cat;
}

async function renameCategory() {
  if (!selectedCategory) {
    showToast("カテゴリを選択してください", "error");
    return;
  }
  const newCat = document.getElementById("new-cat").value.trim();
  if (!newCat) {
    showToast("新しいカテゴリ名を入力してください", "error");
    return;
  }
  const res = await fetch("/api/admin/categories/rename", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ old: selectedCategory, new: newCat })
  });
  if (res.ok) {
    showToast("カテゴリ名を変更しました");
    selectedCategory = "";
    document.getElementById("old-cat").value = "";
    document.getElementById("new-cat").value = "";
    loadCategories();
  } else {
    showToast("変更に失敗しました", "error");
  }
}

async function deleteCategory() {
  if (!selectedCategory) {
    showToast("カテゴリを選択してください", "error");
    return;
  }
  if (!confirm(`「${selectedCategory}」を未分類にしますか？`)) return;
  const res = await fetch("/api/admin/categories/delete", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ category: selectedCategory })
  });
  if (res.ok) {
    showToast("未分類にしました");
    selectedCategory = "";
    document.getElementById("old-cat").value = "";
    loadCategories();
  } else {
    showToast("削除に失敗しました", "error");
  }
}

loadCategories();
</script>

{% endblock %}
