{% extends "base.html" %}
{% block content %}

<div class="card">
  <h1>ユーザー管理</h1>
  <p class="note">ユーザー一覧の表示・削除・管理者権限の切り替えができます。</p>

  <table id="user-table" style="width:100%; border-collapse:collapse; font-size:14px; margin-top:12px;">
    <thead>
      <tr>
        <th style="border-bottom:1px solid #e5e7eb; padding:8px;">ユーザー名</th>
        <th style="border-bottom:1px solid #e5e7eb; padding:8px;">管理者</th>
        <th style="border-bottom:1px solid #e5e7eb; padding:8px;">操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="toast"></div>

<script>
async function loadUsers() {
  const res = await fetch("/api/admin/users");
  const data = await res.json();
  const tbody = document.querySelector("#user-table tbody");
  tbody.innerHTML = data.users.map(u => `
    <tr>
      <td style="border-bottom:1px solid #e5e7eb; padding:8px;">${u.username}</td>
      <td style="border-bottom:1px solid #e5e7eb; padding:8px;">${u.is_admin ? "✔" : ""}</td>
      <td style="border-bottom:1px solid #e5e7eb; padding:8px;">
        <a href="/admin/users/${encodeURIComponent(u.username)}" class="btn btn-gray" style="margin-right:4px;">問題一覧</a>
        <button class="btn btn-gray" onclick="toggleAdmin('${u.username}')">管理者切替</button>
        <button class="btn btn-outline" style="margin-left:4px; background:#dc2626;" onclick="deleteUser('${u.username}')">削除</button>
      </td>
    </tr>
  `).join("");
}

function showToast(msg, type="success") {
  const t = document.createElement("div");
  t.className = "toast " + type;
  t.textContent = msg;
  document.getElementById("toast").appendChild(t);
  setTimeout(() => {
    t.style.opacity = "0";
    t.style.transform = "translateY(8px)";
    setTimeout(() => t.remove(), 400);
  }, 3000);
}

async function toggleAdmin(username) {
  if (!confirm(username + " の管理者権限を切り替えますか？")) return;
  const res = await fetch("/api/admin/toggle_admin/" + encodeURIComponent(username), {
    method: "POST"
  });
  if (res.ok) {
    showToast("変更しました");
    loadUsers();
  } else {
    showToast("変更に失敗しました", "error");
  }
}

async function deleteUser(username) {
  if (!confirm(username + " を削除しますか？（このユーザーの問題も削除されます）")) return;
  const res = await fetch("/api/admin/users/" + encodeURIComponent(username), {
    method: "DELETE"
  });
  if (res.ok) {
    showToast("削除しました");
    loadUsers();
  } else {
    showToast("削除に失敗しました", "error");
  }
}

loadUsers();
</script>

{% endblock %}
